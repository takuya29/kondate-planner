AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Kondate Planner - Bedrock Agent for Meal Planning via Slack

Parameters:
  SlackWorkspaceId:
    Type: String
    Description: "Slack Workspace ID (get from AWS Chatbot console)"
    AllowedPattern: "^[0-9A-Z]{1,255}$"
    ConstraintDescription: "Must be a valid Slack workspace ID"

  SlackChannelId:
    Type: String
    Description: "Slack Channel ID (right-click channel > Copy Link, use last part of URL)"
    AllowedPattern: "^[A-Za-z0-9]+$"
    ConstraintDescription: "Must be a valid Slack channel ID"

Globals:
  Function:
    Runtime: python3.12
    Timeout: 30
    MemorySize: 256
    Architectures:
      - arm64
    Layers:
      - !Ref CommonLayer
    Environment:
      Variables:
        RECIPES_TABLE: !Ref RecipesTable
        HISTORY_TABLE: !Ref MenuHistoryTable

Resources:
  # ==================== DynamoDB Tables ====================
  RecipesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: kondate-recipes
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: recipe_id
          AttributeType: S
      KeySchema:
        - AttributeName: recipe_id
          KeyType: HASH

  MenuHistoryTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: kondate-menu-history
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: date
          AttributeType: S
      KeySchema:
        - AttributeName: date
          KeyType: HASH

  # ==================== Lambda Layer ====================
  CommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: kondate-common-layer
      ContentUri: src/layers/common/
      CompatibleRuntimes:
        - python3.12
      LicenseInfo: 'MIT'
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: python3.12

  # ==================== Bedrock Agent Action Functions ====================
  GetRecipesActionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/agent_actions/get_recipes/
      Handler: app.lambda_handler
      Description: Bedrock Agent action to retrieve recipes
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref RecipesTable

  GetHistoryActionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/agent_actions/get_history/
      Handler: app.lambda_handler
      Description: Bedrock Agent action to retrieve menu history
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref MenuHistoryTable

  SaveMenuActionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/agent_actions/save_menu/
      Handler: app.lambda_handler
      Description: Bedrock Agent action to save menu to history
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref MenuHistoryTable

  # ==================== Bedrock Agent ====================
  KondateAgent:
    Type: AWS::Bedrock::Agent
    Properties:
      AgentName: kondate-planner-agent
      AgentResourceRoleArn: !GetAtt BedrockAgentRole.Arn
      FoundationModel: !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/jp.anthropic.claude-sonnet-4-5-20250929-v1:0'
      Description: Meal planning assistant for Japanese recipes
      IdleSessionTTLInSeconds: 600
      Instruction: |
        You are a helpful meal planning assistant that helps users create balanced Japanese meal plans.

        AVAILABLE RECIPES AND HISTORY:
        - Call get_recipes() to see all available recipes. You can optionally filter by category.
        - Call get_history() to see recent menus (default 30 days). Use this to avoid repeating recipes.

        MEAL PLANNING RULES:
        When generating menu suggestions:
        1. Breakfast: 1-2 dishes (e.g., rice + miso soup, or toast + salad)
        2. Lunch: 1-3 dishes (balanced meal or bento-style)
        3. Dinner: 2-3 dishes (main + side + soup is common)
        4. Variety: Don't repeat the same main protein on consecutive days
        5. Balance: Include vegetables in every meal when possible
        6. Cooking time: Mix quick recipes (<30min) with more involved ones

        RESPONSE FORMAT (IMPORTANT - For Slack compatibility):
        - Keep responses concise and well-structured
        - Use this compact format for menu suggestions:
          **1日目 (Day 1):**
          - 朝食: レシピ名1, レシピ名2
          - 昼食: レシピ名1, レシピ名2
          - 夕食: レシピ名1, レシピ名2, レシピ名3
        - Avoid repeating detailed recipe information (ingredients, cooking time, etc.)
        - Focus on recipe names and categories only
        - Keep additional commentary brief

        WORKFLOW:
        1. When user asks for menu suggestions, fetch recipes and recent history
        2. Generate a menu plan for the requested number of days (typically 3 or 7)
        3. Present the menu clearly with recipe names in compact format
        4. Ask: "この献立で保存しますか？ (Would you like me to save this menu?)"
        5. ONLY call save_menu() if user explicitly confirms (yes/はい/保存して/looks good/etc.)
           - IMPORTANT: When calling save_menu(), you MUST provide the date parameter in YYYY-MM-DD format
           - For today's menu, use today's date
           - For future menus, use the appropriate future date
           - Example: save_menu(date="2025-11-09", meals={...})
        6. If user says no or requests changes, regenerate based on their feedback

        TONE:
        - Be friendly and conversational
        - Respond in Japanese or English based on user's language
        - Provide brief cooking tips or nutritional insights when relevant
      ActionGroups:
        - ActionGroupName: GetRecipes
          Description: Retrieve recipes from database
          ActionGroupExecutor:
            Lambda: !GetAtt GetRecipesActionFunction.Arn
          ApiSchema:
            Payload: |
              openapi: 3.0.0
              info:
                title: Get Recipes API
                version: 1.0.0
                description: Retrieve recipes from DynamoDB, optionally filtered by category
              paths:
                /get-recipes:
                  post:
                    summary: Get recipes
                    description: Retrieve all recipes or filter by category (主菜, 副菜, 汁物, etc.)
                    operationId: getRecipes
                    requestBody:
                      required: false
                      content:
                        application/json:
                          schema:
                            type: object
                            properties:
                              category:
                                type: string
                                description: Optional category filter (e.g., 主菜, 副菜, 汁物)
                    responses:
                      '200':
                        description: Successful response
                        content:
                          application/json:
                            schema:
                              type: object
                              properties:
                                recipes:
                                  type: array
                                  items:
                                    type: object
                                    properties:
                                      recipe_id:
                                        type: string
                                      name:
                                        type: string
                                      category:
                                        type: string
                                      cooking_time:
                                        type: number
                                      ingredients:
                                        type: array
                                        items:
                                          type: string
                                      recipe_url:
                                        type: string
                                      tags:
                                        type: array
                                        items:
                                          type: string
        - ActionGroupName: GetHistory
          Description: Retrieve menu history
          ActionGroupExecutor:
            Lambda: !GetAtt GetHistoryActionFunction.Arn
          ApiSchema:
            Payload: |
              openapi: 3.0.0
              info:
                title: Get Menu History API
                version: 1.0.0
                description: Retrieve menu history for the past N days
              paths:
                /get-history:
                  post:
                    summary: Get menu history
                    description: Retrieve menu history for past N days (default 30, max 365). Use this to avoid repeating recent recipes.
                    operationId: getHistory
                    requestBody:
                      required: false
                      content:
                        application/json:
                          schema:
                            type: object
                            properties:
                              days:
                                type: integer
                                description: Number of days to retrieve (1-365, default 30)
                                minimum: 1
                                maximum: 365
                    responses:
                      '200':
                        description: Successful response
                        content:
                          application/json:
                            schema:
                              type: object
                              properties:
                                history:
                                  type: array
                                  items:
                                    type: object
                                    properties:
                                      date:
                                        type: string
                                        format: date
                                      meals:
                                        type: object
                                        properties:
                                          breakfast:
                                            type: array
                                            items:
                                              type: object
                                              properties:
                                                recipe_id:
                                                  type: string
                                                name:
                                                  type: string
                                          lunch:
                                            type: array
                                            items:
                                              type: object
                                          dinner:
                                            type: array
                                            items:
                                              type: object
                                      recipes:
                                        type: array
                                        items:
                                          type: string
                                        description: Flat list of all recipe IDs used this day
                                      notes:
                                        type: string
        - ActionGroupName: SaveMenu
          Description: Save approved menus
          ActionGroupExecutor:
            Lambda: !GetAtt SaveMenuActionFunction.Arn
          ApiSchema:
            Payload: |
              openapi: 3.0.0
              info:
                title: Save Menu API
                version: 1.0.0
                description: Save a confirmed menu plan to history
              paths:
                /save-menu:
                  post:
                    summary: Save menu
                    description: Save a menu plan to history. ONLY call this after user explicitly confirms (yes/はい/保存して/looks good).
                    operationId: saveMenu
                    requestBody:
                      required: true
                      content:
                        application/json:
                          schema:
                            type: object
                            required:
                              - date
                              - meals
                            properties:
                              date:
                                type: string
                                format: date
                                description: Date in YYYY-MM-DD format
                              meals:
                                type: object
                                required:
                                  - breakfast
                                  - lunch
                                  - dinner
                                properties:
                                  breakfast:
                                    type: array
                                    items:
                                      type: object
                                      required:
                                        - recipe_id
                                        - name
                                      properties:
                                        recipe_id:
                                          type: string
                                        name:
                                          type: string
                                  lunch:
                                    type: array
                                    items:
                                      type: object
                                      required:
                                        - recipe_id
                                        - name
                                  dinner:
                                    type: array
                                    items:
                                      type: object
                                      required:
                                        - recipe_id
                                        - name
                              notes:
                                type: string
                                description: Optional notes about this menu
                    responses:
                      '200':
                        description: Successful response
                        content:
                          application/json:
                            schema:
                              type: object
                              properties:
                                success:
                                  type: boolean
                                date:
                                  type: string
                                message:
                                  type: string

  KondateAgentAlias:
    Type: AWS::Bedrock::AgentAlias
    DependsOn: KondateAgent
    Properties:
      AgentId: !GetAtt KondateAgent.AgentId
      AgentAliasName: production
      Description: Production alias with inference profile support

  # ==================== Amazon Q Developer / Chatbot ====================
  DeveloperQSlackChannel:
    Type: AWS::Chatbot::SlackChannelConfiguration
    Properties:
      ConfigurationName: kondate-developer-q-channel
      IamRoleArn: !GetAtt AmazonQChatbotRole.Arn
      SlackWorkspaceId: !Ref SlackWorkspaceId
      SlackChannelId: !Ref SlackChannelId
      LoggingLevel: INFO
      CustomizationResourceArns:
        - !GetAtt KondateAgentAlias.AgentAliasArn
      GuardrailPolicies:
        - arn:aws:iam::aws:policy/ReadOnlyAccess

  # ==================== Amazon Q / Chatbot IAM Role ====================
  AmazonQChatbotRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: kondate-amazonq-chatbot-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: chatbot.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchLogsReadOnlyAccess
      Policies:
        - PolicyName: InvokeBedrockAgent
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeAgent
                  - bedrock:GetAgent
                  - bedrock:ListAgents
                Resource:
                  - !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:agent/*'
                  - !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:agent-alias/*/*'

  # ==================== Bedrock Agent IAM Role ====================
  BedrockAgentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: kondate-bedrock-agent-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:agent/*'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchLogsFullAccess
      Policies:
        - PolicyName: InvokeActionLambdas
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: lambda:InvokeFunction
                Resource:
                  - !GetAtt GetRecipesActionFunction.Arn
                  - !GetAtt GetHistoryActionFunction.Arn
                  - !GetAtt SaveMenuActionFunction.Arn
        - PolicyName: InvokeFoundationModel
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:GetInferenceProfile
                  - bedrock:GetFoundationModel
                Resource:
                  # Inference Profile (cross-region)
                  - !Sub 'arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/jp.anthropic.claude-sonnet-4-5-20250929-v1:0'
                  # Foundation models in both regions
                  - 'arn:aws:bedrock:ap-northeast-1::foundation-model/anthropic.claude-sonnet-4-5-20250929-v1:0'
                  - 'arn:aws:bedrock:ap-northeast-3::foundation-model/anthropic.claude-sonnet-4-5-20250929-v1:0'

  # ==================== Lambda Resource-based Policies (Allow Bedrock to invoke) ====================
  GetRecipesActionInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetRecipesActionFunction
      Action: lambda:InvokeFunction
      Principal: bedrock.amazonaws.com
      SourceAccount: !Ref AWS::AccountId

  GetHistoryActionInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GetHistoryActionFunction
      Action: lambda:InvokeFunction
      Principal: bedrock.amazonaws.com
      SourceAccount: !Ref AWS::AccountId

  SaveMenuActionInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SaveMenuActionFunction
      Action: lambda:InvokeFunction
      Principal: bedrock.amazonaws.com
      SourceAccount: !Ref AWS::AccountId

Outputs:
  # ==================== DynamoDB ====================
  RecipesTableName:
    Description: "DynamoDB Recipes table name"
    Value: !Ref RecipesTable

  MenuHistoryTableName:
    Description: "DynamoDB Menu History table name"
    Value: !Ref MenuHistoryTable

  # ==================== Lambda Functions ====================
  GetRecipesActionFunctionArn:
    Description: "ARN of GetRecipesAction Lambda"
    Value: !GetAtt GetRecipesActionFunction.Arn

  GetHistoryActionFunctionArn:
    Description: "ARN of GetHistoryAction Lambda"
    Value: !GetAtt GetHistoryActionFunction.Arn

  SaveMenuActionFunctionArn:
    Description: "ARN of SaveMenuAction Lambda"
    Value: !GetAtt SaveMenuActionFunction.Arn

  # ==================== Bedrock Agent ====================
  BedrockAgentId:
    Description: "Bedrock Agent ID"
    Value: !GetAtt KondateAgent.AgentId

  BedrockAgentArn:
    Description: "Bedrock Agent ARN"
    Value: !GetAtt KondateAgent.AgentArn

  BedrockAgentAliasId:
    Description: "Bedrock Agent Alias ID (production)"
    Value: !GetAtt KondateAgentAlias.AgentAliasId

  BedrockAgentAliasArn:
    Description: "Bedrock Agent Alias ARN (use this in AWS Chatbot)"
    Value: !GetAtt KondateAgentAlias.AgentAliasArn

  # ==================== IAM Roles ====================
  AmazonQChatbotRoleArn:
    Description: "IAM Role ARN for Amazon Q / Chatbot"
    Value: !GetAtt AmazonQChatbotRole.Arn

  BedrockAgentRoleArn:
    Description: "IAM Role ARN for Bedrock Agent"
    Value: !GetAtt BedrockAgentRole.Arn

  # ==================== Developer Q / Chatbot ====================
  DeveloperQSlackChannelArn:
    Description: "Developer Q Slack Channel Configuration ARN"
    Value: !Ref DeveloperQSlackChannel

  # ==================== Setup Instructions ====================
  NextSteps:
    Description: "Post-deployment setup instructions"
    Value: |
      Deployment complete! Your Bedrock Agent and Developer Q Slack channel are ready.

      1. Test the agent in Slack:
         - Go to your configured Slack channel
         - Type: @AWS 3日分の献立を提案して

      2. Test in Bedrock Console (optional):
         - Navigate to Amazon Bedrock > Agents
         - Select kondate-planner-agent
         - Use the built-in test interface

      3. Seed sample data (if not done already):
         python scripts/seed_data.py --recipes 20 --history 30

      Note: If you need to update Slack workspace/channel IDs later,
      use `sam deploy` with --parameter-overrides
